# 实时切面更新接口

## 接口路径
`src/core/algorithms/services/RealTimeUpdateService.ts`

## 功能说明
实时切面更新服务负责处理探头移动时的实时切面计算和更新，支持探头位置变化时的实时切面计算，确保响应时间小于100ms，提供流畅的切面显示体验。

## 请求参数

### RealTimeUpdateService.updateSection方法
```typescript
updateSection(
  probePosition: Vector3,
  probeDirection: Vector3,
  heartModel: HeartModel
): IntersectionResult
```

**参数说明：**
- `probePosition: Vector3` - 探头位置坐标
- `probeDirection: Vector3` - 探头方向向量
- `heartModel: HeartModel` - 心脏模型数据

### HeartModel接口
```typescript
interface HeartModel {
  triangles: Vector3[][];
}
```

### IntersectionResult接口
```typescript
interface IntersectionResult {
  lines: Vector3[][];        // 交线结果，每条交线由两个点组成
  isValid: boolean;          // 计算结果是否有效
  calculationTime: number;   // 计算耗时（毫秒）
  fromCache?: boolean;       // 是否来自缓存
  error?: string;           // 错误信息
}
```

## 响应格式

### 成功响应示例
```typescript
{
  lines: [
    [new Vector3(-0.5, 0, 0), new Vector3(0.5, 0, 0)],
    [new Vector3(0, -0.5, 0), new Vector3(0, 0.5, 0)]
  ],
  isValid: true,
  calculationTime: 15.2,
  fromCache: false
}
```

### 错误响应示例
```typescript
{
  lines: [],
  isValid: false,
  calculationTime: 0,
  error: "无效的探头位置或方向"
}
```

## 逻辑

### 核心算法流程
1. **参数验证** - 检查探头位置和方向的有效性
2. **缓存检查** - 使用缓存键检查是否已有计算结果
3. **平面创建** - 根据探头位置和方向创建切割平面
4. **交线计算** - 计算平面与心脏模型的交线
5. **结果缓存** - 缓存有效结果供后续使用
6. **性能监控** - 记录计算时间和缓存命中率

### 性能优化策略
- **结果缓存**：使用精确的缓存键避免重复计算
- **增量计算**：优化三角形检查顺序，优先检查可能相交的三角形
- **精度控制**：使用固定精度减少浮点数精度问题
- **错误处理**：完善的异常处理和边界情况处理

## 响应示例

### 正常计算响应
```typescript
// 探头在原点，方向朝上，与简单三角形相交
const result = service.updateSection(
  new Vector3(0, 0, 0),
  new Vector3(0, 1, 0),
  {
    triangles: [
      [new Vector3(-1, -1, 0), new Vector3(1, -1, 0), new Vector3(0, 1, 0)]
    ]
  }
);

// 响应：
{
  lines: [
    [new Vector3(-0.5, 0, 0), new Vector3(0.5, 0, 0)]
  ],
  isValid: true,
  calculationTime: 12.5,
  fromCache: false
}
```

### 缓存命中响应
```typescript
// 相同参数第二次调用
const result = service.updateSection(
  new Vector3(0, 0, 0),
  new Vector3(0, 1, 0),
  {
    triangles: [
      [new Vector3(-1, -1, 0), new Vector3(1, -1, 0), new Vector3(0, 1, 0)]
    ]
  }
);

// 响应：
{
  lines: [
    [new Vector3(-0.5, 0, 0), new Vector3(0.5, 0, 0)]
  ],
  isValid: true,
  calculationTime: 0,
  fromCache: true
}
```

### 错误情况响应
```typescript
// 无效探头位置
const result = service.updateSection(
  new Vector3(NaN, 0, 0),
  new Vector3(0, 1, 0),
  {
    triangles: [
      [new Vector3(-1, -1, 0), new Vector3(1, -1, 0), new Vector3(0, 1, 0)]
    ]
  }
);

// 响应：
{
  lines: [],
  isValid: false,
  calculationTime: 0,
  error: "无效的探头位置或方向"
}
```

## 相关文件

### 核心实现文件
- `src/core/algorithms/services/RealTimeUpdateService.ts` - 实时切面更新服务实现
- `src/core/algorithms/geometry/Plane.ts` - 平面定义和计算
- `src/core/algorithms/geometry/Vector3.ts` - 三维向量运算

### 测试文件
- `tests/unit/algorithms/real-time-update.test.ts` - 实时切面更新服务测试
- `tests/unit/algorithms/geometry.test.ts` - 几何计算基础测试
- `tests/unit/algorithms/intersection.test.ts` - 平面-网格求交算法测试

### 依赖模块
- `src/core/algorithms/geometry/index.ts` - 几何计算模块导出
- `src/core/types/STLModel.ts` - STL模型类型定义

## 性能指标

### 计算性能要求
- **响应时间**：< 100ms
- **缓存命中率**：目标 > 70%
- **内存使用**：合理范围内，支持大模型

### 质量指标
- **测试覆盖率**：≥ 90%
- **边界情况处理**：完整覆盖
- **错误处理**：完善的异常处理机制

## 使用示例

### 基本使用
```typescript
import { RealTimeUpdateService } from '../core/algorithms/services/RealTimeUpdateService';
import { Vector3 } from '../core/algorithms/geometry/index';

const service = new RealTimeUpdateService();

// 模拟探头移动
const probePosition = new Vector3(0, 0, 0);
const probeDirection = new Vector3(0, 1, 0);
const heartModel = {
  triangles: [
    [new Vector3(-1, -1, 0), new Vector3(1, -1, 0), new Vector3(0, 1, 0)]
  ]
};

// 计算切面
const result = service.updateSection(probePosition, probeDirection, heartModel);

if (result.isValid) {
  console.log(`切面计算成功，耗时：${result.calculationTime}ms`);
  console.log(`交线数量：${result.lines.length}`);
} else {
  console.error(`切面计算失败：${result.error}`);
}
```

### 性能监控
```typescript
// 获取性能统计
const stats = service.getPerformanceStats();
console.log(`缓存命中率：${(stats.cacheHitRate * 100).toFixed(2)}%`);
console.log(`总计算次数：${stats.totalCalculations}`);
console.log(`缓存命中：${stats.cacheHits}，缓存未命中：${stats.cacheMisses}`);

// 清空缓存
service.clearCache();
```

这个接口为食道超声模拟软件提供了实时切面计算的核心功能，确保在探头移动时能够快速准确地更新切面显示，满足实时交互的性能要求。
